<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Code Dependencies Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 0; }
        #graph { width: 100vw; height: 100vh; }
        .node { cursor: pointer; }
        .node text { 
            font-family: Arial, sans-serif;
            font-size: 12px;
            fill: #333;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        .link { 
            stroke: #999; 
            stroke-opacity: 0.6; 
        }
        .tooltip {
            position: absolute;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 6px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            pointer-events: none;
            max-width: 400px;
            word-wrap: break-word;
            white-space: normal;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            line-height: 1.4;
        }
        .tooltip h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
        }
        .tooltip .path {
            word-break: break-all;
            margin-bottom: 8px;
        }
        .tooltip .description {
            font-style: italic;
            color: #ccc;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div id="graph"></div>
    <script>
        const data = {"nodes": [{"id": 0, "name": "DemoController.java", "full_name": "src/main/java/com/macro/mall/demo/controller/DemoController.java", "type": "file", "community_id": null, "color": "#666666", "degree": 24, "radius": 14.696938456699067, "description": "", "community_description": ""}, {"id": 1, "name": "DemoServiceImpl.java", "full_name": "src/main/java/com/macro/mall/demo/service/impl/DemoServiceImpl.java", "type": "file", "community_id": null, "color": "#666666", "degree": 13, "radius": 10.816653826391967, "description": "", "community_description": ""}, {"id": 2, "name": "DemoService.java", "full_name": "src/main/java/com/macro/mall/demo/service/DemoService.java", "type": "file", "community_id": null, "color": "#666666", "degree": 32, "radius": 16.970562748477143, "description": "", "community_description": ""}, {"id": 3, "name": "PmsBrandDto.java", "full_name": "src/main/java/com/macro/mall/demo/dto/PmsBrandDto.java", "type": "file", "community_id": null, "color": "#666666", "degree": 36, "radius": 18.0, "description": "", "community_description": ""}, {"id": 4, "name": "AdminUserDetails.java", "full_name": "src/main/java/com/macro/mall/demo/bo/AdminUserDetails.java", "type": "file", "community_id": null, "color": "#666666", "degree": 5, "radius": 8, "description": "", "community_description": ""}, {"id": 5, "name": "SecurityConfig.java", "full_name": "src/main/java/com/macro/mall/demo/config/SecurityConfig.java", "type": "file", "community_id": null, "color": "#666666", "degree": 3, "radius": 8, "description": "", "community_description": ""}, {"id": 6, "name": "RestTemplateDemoController.java", "full_name": "src/main/java/com/macro/mall/demo/controller/RestTemplateDemoController.java", "type": "file", "community_id": null, "color": "#666666", "degree": 8, "radius": 8.485281374238571, "description": "", "community_description": ""}, {"id": 7, "name": "MyBatisConfig.java", "full_name": "src/main/java/com/macro/mall/demo/config/MyBatisConfig.java", "type": "file", "community_id": null, "color": "#666666", "degree": 2, "radius": 8, "description": "", "community_description": ""}], "links": [{"source": 0, "target": 0, "weight": 4.0, "idents": ["createBrand", "listBrand", "deleteBrand", "updateBrand"]}, {"source": 0, "target": 1, "weight": 6.0, "idents": ["getBrand", "updateBrand", "deleteBrand", "listBrand", "createBrand", "listAllBrand"]}, {"source": 0, "target": 2, "weight": 6.0, "idents": ["getBrand", "updateBrand", "deleteBrand", "listBrand", "createBrand", "listAllBrand"]}, {"source": 1, "target": 2, "weight": 1.0, "idents": ["DemoService"]}, {"source": 2, "target": 0, "weight": 4.0, "idents": ["createBrand", "listBrand", "deleteBrand", "updateBrand"]}, {"source": 2, "target": 1, "weight": 6.0, "idents": ["getBrand", "updateBrand", "deleteBrand", "listBrand", "createBrand", "listAllBrand"]}, {"source": 2, "target": 2, "weight": 7.0, "idents": ["getBrand", "updateBrand", "DemoService", "deleteBrand", "listBrand", "createBrand", "listAllBrand"]}, {"source": 2, "target": 3, "weight": 1.4142135623730951, "idents": ["PmsBrandDto"]}, {"source": 3, "target": 3, "weight": 17.0, "idents": ["setFactoryStatus", "getName", "getFirstLetter", "setLogo", "setBigPic", "getLogo", "getBigPic", "getShowStatus", "setBrandStory", "setFirstLetter", "setName", "getSort", "PmsBrandDto", "getFactoryStatus", "setShowStatus", "setSort", "getBrandStory"]}, {"source": 4, "target": 4, "weight": 2.0, "idents": ["getUsername", "getPassword"]}, {"source": 5, "target": 4, "weight": 1.0, "idents": ["AdminUserDetails"]}, {"source": 5, "target": 5, "weight": 1.4142135623730951, "idents": ["userDetailsService"]}, {"source": 6, "target": 6, "weight": 5.146264369941973, "idents": ["getForObject", "postForObject", "postForEntity", "getForEntity"]}, {"source": 7, "target": 7, "weight": 1.0, "idents": ["MyBatisConfig"]}]};
        
        /* 创建SVG */
        const width = window.innerWidth;
        const height = window.innerHeight;
        const svg = d3.select("#graph")
            .append("svg")
            .attr("width", width)
            .attr("height", height);
            
        /* 创建缩放和平移行为 */
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (event) => {
                container.attr("transform", event.transform);
            });
            
        svg.call(zoom);
        
        const container = svg.append("g");
        
        /* 创建力导向图布局 */
        const simulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.links)
                .id(d => d.id)
                .distance(d => {
                    const nodeCount = data.nodes.length;
                    const linkCount = data.links.length;
                    const baseDist = 50;
                    const nodeRatio = nodeCount / 100;  // 每100个节点增加一倍基础距离
                    const linkRatio = linkCount / 500;  // 每500条边增加一倍基础距离
                    return baseDist * (1 + nodeRatio) * (1 + linkRatio);
                })
                .strength(0.2))  /* 减小link force的strength */
            .force("charge", d3.forceManyBody()
                .strength(d => {
                    const nodeCount = data.nodes.length;
                    const baseCharge = -100;
                    const chargeRatio = nodeCount / 100;  // 每100个节点增加一倍斥力
                    return baseCharge * (1 + chargeRatio);
                }))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("x", d3.forceX(width / 2).strength(0.05))
            .force("y", d3.forceY(height / 2).strength(0.05))
            .force("collide", d3.forceCollide()
                .radius(d => d.radius * 2.5)  /* 增加碰撞半径 */
                .strength(1)
                .iterations(3))
            .alphaDecay(0.01)  /* 减缓alpha衰减速度 */
            .velocityDecay(0.5);  /* 减缓速度衰减 */
            
        /* 绘制连接线 */
        const link = container.append("g")
            .selectAll("line")
            .data(data.links)
            .join("line")
            .attr("class", "link")
            .attr("stroke-width", d => Math.sqrt(d.weight));
            
        /* 创建节点组 */
        const node = container.append("g")
            .selectAll(".node")
            .data(data.nodes)
            .join("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
                
        /* 添加节点圆圈 */
        node.append("circle")
            .attr("r", d => d.radius)
            .attr("fill", d => d.color)
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5);
            
        /* 添加节点标签 */
        node.append("text")
            .text(d => d.name)
            .attr("dy", d => d.radius * 2.5 + 5)  /* 增加标签与节点的距离 */
            .attr("text-anchor", "middle")
            .style("font-size", d => Math.max(10, Math.min(d.radius * 0.8, 14)) + "px")
            .each(function(d) {  /* 检测并避��标签重叠 */
                const bbox = this.getBBox();
                d.labelHeight = bbox.height;
                d.labelWidth = bbox.width;
            });
            
        /* 设置初始缩放以适应屏幕 */
        const bounds = container.node().getBBox();
        const padding = 50;  /* 添加边距 */
        const scale = Math.min(
            (width - padding * 2) / bounds.width,
            (height - padding * 2) / bounds.height
        ) * 0.95;  /* 留出更多边距 */
        
        /* 计算平移距离，确保图形居中 */
        const tx = (width - bounds.width * scale) / 2 - bounds.x * scale;
        const ty = (height - bounds.height * scale) / 2 - bounds.y * scale;
        
        /* 立即应用变换，不使用动画 */
        container.attr("transform", `translate(${tx},${ty})scale(${scale})`);
        
        /* 更新力导向图的alpha值以确保布局稳定 */
        simulation.alpha(0.3).restart();
        
        /* 在tick事件中处理标签位置，避免重叠 */
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
                
            node.attr("transform", d => `translate(${d.x},${d.y})`);
            
            /* 标签碰撞检测和调整 */
            const labels = node.selectAll("text");
            labels.each(function(d1) {
                labels.each(function(d2) {
                    if (d1.id !== d2.id) {
                        const dx = d1.x - d2.x;
                        const dy = d1.y - d2.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        const minDist = (d1.labelHeight + d2.labelHeight) / 2 + 10;
                        
                        if (dist < minDist) {
                            const angle = Math.atan2(dy, dx);
                            const moveDistance = (minDist - dist) / 2;
                            
                            d1.y += Math.sin(angle) * moveDistance;
                            d2.y -= Math.sin(angle) * moveDistance;
                        }
                    }
                });
            });
        });
        
        /* 添加提示框 */
        const tooltip = d3.select("body")
            .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
            
        /* 节点交互 */
        node.on("mouseover", (event, d) => {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                    
                let tooltipContent = `<h4>${d.name}</h4>`;
                tooltipContent += `<div class="path"><strong>Full path:</strong><br>${d.full_name}</div>`;
                tooltipContent += `<strong>Degree:</strong> ${d.degree}<br>`;
                
                if (d.community_id !== null) {
                    tooltipContent += `<div class="description"><strong>Community:</strong><br>${d.community_description}</div>`;
                }
                
                if (d.description) {
                    tooltipContent += `<div class="description"><strong>File:</strong><br>${d.description}</div>`;
                }
                
                tooltip.html(tooltipContent)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", () => {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });
            
        /* 拖拽函数 */
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }
        
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }
        
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
    </script>
</body>
</html>
